<!doctype html> 
<html lang="en"> 
    <head> 
        <meta charset="utf-8"> 
        <title>Do our projects build?</title> 
        <style> 
            body, html {
                height: 100%;
            }
            body {
                padding: 0;
                margin: 0;
                color: #FFF;
                font-family: "Trebuchet MS", sans-serif;
                font-size: 12px;
                text-align: center;
                padding-top: 100px;
            }
            
            body.success {
                background: #234F32;
                background-image: -webkit-gradient(linear, left bottom, left top, color-stop(0, #092E20), color-stop(1, #234F32));
                background-image: -moz-linear-gradient(center bottom, #092E20 0%, #234F32 100%);
            }
            
            body.fail {
                background: red;
            }

            body.running {
                background: blue;
            }
            
            #answer {
                font-weight: bold;
                font-size: 200px;
                text-shadow: #000 0 1px 3px;
                text-rendering: optimizeLegibility;
            }
            a {
                color: #FFC757;
                text-decoration: none;
            }
        </style> 
    </head> 
    <body class="running" id="body">
        <h1>Do our projects build?</h1>
        <div id="answer">Let me check!</div>
        
        <script src="https://ajax.googleapis.com/ajax/libs/mootools/1.3.1/mootools-yui-compressed.js"></script>
        <script src="more.js"></script>
        <script>
        window.addEvent('domready', function() {

            var JENKINS_URL = 'http://ci.django-cms.org';

            var INTERVAL = 2500;

            var TEXT = {
                OK: "YES!",
                FAIL: "NO!",
                RUNNING: "Running..."
            };
            
            var CLASSES = {
                OK: "success",
                FAIL: "fail",
                RUNNING: "running"
            }

            var answer = $('answer');
            var body = $('body');

            // Some Constants
            
            var OK =        "OK";
            var FAIL =      "FAIL";
            var PENDING =   "PENDING";
            var DISABLED =  "DISABLED";
            var ABORTED =   "ABORTED";
            var UNSTABLE =  "UNSTABLE";
            var RUNNING =   "RUNNING";

            // All color codes allow the '_anime' suffix which indicates a build
            // is running from the current state to possibly a new state.
            // General comment to the colors: WTF?
            var COLORS = {
                FAIL:       'red',
                UNSTABLED:  'yellow',
                OK:         'blue', // WTF?
                DISABLED:   'disabled',
                ABORTED:    'aborted',
                PENDING:    'grey'
            }

            var R_COLORS = {}
            Object.each(COLORS, function(key, item){
                R_COLORS[key] = item;
                R_COLORS[key + '_anime'] = RUNNING;
            });

            var ORDER = [OK, RUNNING, FAIL];

             function getStatusProjects(jobs){
                var splitted = {
               		FAIL: [],
               		OK: [],
               		PENDING: [],
               		DISABLED: [],
               		ABORTED: [],
               		UNSTABLE: []
                };

                var overallStatus = OK;
                var oldIndex = ORDER.indexOf(overallStatus);
                jobs.each(function (job){
                    var jobStatus = R_COLORS[job.color];
                    if (jobStatus == RUNNING){
                    	var oldColor = job.color.substr(0, job.color.length - 6);
                    	jobStatus = RUNNING;
                    } else {
                        splitted[jobStatus].push(job);
                    }
                    var newIndex = ORDER.indexOf(jobStatus);
                    if (newIndex > oldIndex){
                    	overallStatus = jobStatus;
                    }
                });
                return {
                	splitted: splitted,
                    overallStatus: overallStatus
                };
            }

            function update(jobs){
                var projectStatus = getStatusProjects(jobs);
                answer.set('text', TEXT[projectStatus.overallStatus]);
                body.set('class', CLASSES[projectStatus.overallStatus]);
            }

            function check(){
                new Request.JSONP({
                    url: JENKINS_URL + '/api/json',
                    callbackKey: 'jsonp',
                    onSuccess: function(data){
                        update(data.jobs);
                    }
                }).send();
            }

            check();
            check.periodical(INTERVAL);
        });
        </script>        
    </body> 
</html> 
